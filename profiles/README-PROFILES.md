# Profiles System - Office Word MCP Server

## Overview

The profiles system allows you to deploy specialized versions of the Word MCP Server with only the tools needed for specific use cases. This simplifies Copilot Studio integration by reducing the number of tools from 67 to 10-15.

## Available Profiles

### 1. Full (67 tools)
**Connector Name**: `word-mcp-connector`
**Use Case**: Development, testing, general-purpose document automation
**Status**: Deployed ✅
**URL**: https://word-mcp-connector.ashywater-9eb5a210.francecentral.azurecontainerapps.io

### 2. Create Propal (13 tools) ⭐
**Connector Name**: `word-mcp-proposal`
**Use Case**: Commercial proposal generation from templates
**Status**: Deployed ✅
**URL**: https://word-mcp-proposal.ashywater-9eb5a210.francecentral.azurecontainerapps.io

**Tools Included**:
- `list_all_templates` - List available templates
- `list_all_documents` - List all documents
- `create_document_from_template` - Create from template with variables
- `replace_text_universal` - Replace text everywhere
- `add_paragraph` - Add paragraphs
- `add_heading` - Add headings
- `add_table` - Create Word tables
- `format_table` - Format tables with borders/shading
- `highlight_table_header` - Format table headers
- `apply_table_alternating_rows` - Alternating row colors
- `download_document` - Get download links
- `get_document_info` - Get document metadata
- `check_document_exists` - Verify document exists

**Workflow Validated**: ✅
- Template → Variable replacement → Real Word table → Formatting → Download
- Test time: 26.74s (well under 30s timeout)

### 3. Document Editor (10 tools)
**Status**: Not deployed yet
**Use Case**: Simple document editing and formatting

### 4. Template Manager (7 tools)
**Status**: Not deployed yet
**Use Case**: Template creation and management

### 5. Minimal (5 tools)
**Status**: Not deployed yet
**Use Case**: Quick testing and validation

## Deployment Process

### Generate a Profile
```bash
python3 generate_profile.py <profile-name>
```

This creates:
- `profiles/swagger-<profile>.json` - Filtered swagger
- `profiles/wrapper-<profile>.py` - FastAPI wrapper
- `profiles/Dockerfile.<profile>` - Docker build config
- `profiles/deploy-<profile>.sh` - Deployment script
- `profiles/test-<profile>.py` - Test script

### Deploy a Profile
```bash
./profiles/deploy-<profile>.sh <ACR_NAME> <RESOURCE_GROUP> <ENVIRONMENT> <API_KEY>
```

Example:
```bash
./profiles/deploy-create-propal.sh mywordmcpacr my-word-mcp-rg my-word-mcp-env "YOUR_API_KEY"
```

The deployment script automatically:
1. Builds and pushes Docker image to ACR
2. Creates/updates Azure Container App
3. Configures managed identity
4. Assigns Storage Blob Data Contributor role
5. Configures environment variables

**Note**: Role propagation takes 2-5 minutes after first deployment.

### Test a Profile
```bash
python3 profiles/test-<profile>.py
```

Or run the complete workflow test:
```bash
python3 test_workflow_complete.py
```

## Copilot Studio Integration

### Using Profiles in Power Apps

1. **Import Swagger**: Use `profiles/swagger-<profile>.json`
2. **Configure Authentication**:
   - Type: API Key
   - Parameter name: X-API-Key
   - Location: Header
3. **Test Connection**: Verify with a simple endpoint like `list_all_templates`
4. **Add to Copilot Studio**: Import the Custom Connector

### Advantages of Profiles

**Full Version (67 tools)**:
- ❌ 3 hours to add tools manually in Copilot Studio
- ❌ Complex to manage and test
- ❌ Most tools unused for specific use cases

**Profile Version (10-15 tools)**:
- ✅ 15-30 minutes to add tools manually
- ✅ Focused on specific use case
- ✅ Easier to test and validate
- ✅ Clearer bot capabilities

## Architecture

### Base Project Structure
```
/home/eric/projects/my-Office-Word-MCP-Server/
├── word_document_server/     # Core MCP server (67 tools)
│   ├── tools/                # All tool implementations
│   └── core/                 # Document manipulation logic
├── connector_wrapper.py      # Full FastAPI wrapper
├── word-connector.swagger.json  # Full swagger (67 tools)
└── profiles/                 # Specialized versions
    ├── profiles.json         # Profile definitions
    ├── generate_profile.py   # Profile generator
    ├── swagger-*.json        # Filtered swagger files
    ├── wrapper-*.py          # Profile wrappers
    ├── Dockerfile.*          # Profile Dockerfiles
    ├── deploy-*.sh           # Deployment scripts
    └── test-*.py             # Test scripts
```

### Profile Generation

Profiles are generated by:
1. Reading `profiles.json` configuration
2. Filtering tools from full swagger
3. Creating specialized wrapper that imports from base `connector_wrapper.py`
4. Generating deployment and test scripts

## Configuration

### Environment Variables

All profiles use these environment variables:
- `MCP_TRANSPORT=http` - Transport mode
- `MCP_HOST=0.0.0.0` - Host binding
- `MCP_PORT=8080` - HTTP port
- `MCP_PATH=/mcp` - MCP endpoint path
- `AZURE_STORAGE_ACCOUNT_NAME` - Azure storage account
- `API_KEY` - API key for authentication

### Azure Resources Required

- **Azure Container Registry**: For Docker images
- **Azure Container Apps Environment**: For hosting
- **Azure Storage Account**: For documents and templates
- **Managed Identity**: Auto-configured by deployment script
- **Role Assignment**: Storage Blob Data Contributor (auto-configured)

## Testing

### Automated Tests

Each profile includes a test script that validates:
- Root endpoint connectivity
- API key authentication
- All profile endpoints
- Response format
- Error handling

### Workflow Tests

The `test_workflow_complete.py` script validates end-to-end workflows:
1. Create document from template
2. Replace variables
3. Create real Word table (not markdown)
4. Format table (header, borders, alternating rows)
5. Add conclusion paragraph
6. Generate download link

**Current Result**: ✅ 26.74s (all steps successful)

## Next Steps

### For Immediate Use
1. ✅ Deploy `create-propal` profile (DONE)
2. Import `profiles/swagger-create-propal.json` to Power Apps
3. Configure API key authentication
4. Test in Copilot Studio

### For Future Profiles
1. Review `profiles.json` and adjust tool lists as needed
2. Generate new profiles with `python3 generate_profile.py <name>`
3. Deploy with `./profiles/deploy-<name>.sh`
4. Test with `python3 profiles/test-<name>.py`

## Troubleshooting

### Common Issues

**1. Authorization Error on First Deployment**
```
AuthorizationPermissionMismatch
```
**Solution**: Wait 2-5 minutes for Azure role assignment to propagate

**2. Container Not Starting**
```
Application initialization failed
```
**Solution**: Check container logs with:
```bash
az containerapp logs show --name word-mcp-proposal --resource-group my-word-mcp-rg --tail 50
```

**3. Tools Not Visible in Power Apps**
**Solution**: Ensure endpoints are POST (not GET) for tools with required parameters

### Validation Checklist

Before deploying to Copilot Studio:
- [ ] Profile swagger imported successfully (0 errors)
- [ ] API key authentication configured
- [ ] Test connection successful
- [ ] Key endpoints tested (list_all_templates, create_document_from_template)
- [ ] Complete workflow test passed
- [ ] Response format validated (JSON object with "result" property)

## Support

For issues or questions:
- Check deployment logs: `az containerapp logs show`
- Review test results: `python3 profiles/test-<profile>.py`
- Run workflow validation: `python3 test_workflow_complete.py`
- Update swagger if needed: Regenerate profile with `generate_profile.py`
